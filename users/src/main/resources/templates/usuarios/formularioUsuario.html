<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${titulo} ?: 'Adicionar Usuário'">Adicionar Usuário</title>
    <link rel="icon" href="data:,">
    <style>
        :root{
          --bg:#ffffff; --fg:#111; --muted:#666; --border:#e5e7eb; --card:#fff; --btn:#fff; --accent:#3498db;
        }
        .dark{
          --bg:#0f172a; --fg:#e5e7eb; --muted:#9ca3af; --border:#334155; --card:#0b1220; --btn:#0b1220; --accent:#60a5fa;
        }
        html,body{height:100%}
        body{margin:0; font-family:system-ui, Arial, sans-serif; background:var(--bg); color:var(--fg); display:flex; flex-direction:column}

        header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--border); padding:12px 20px}
        .topbar{display:flex; align-items:center; justify-content:space-between; gap:16px}
        .brand{font-weight:800}
        nav a{margin-right:8px; text-decoration:none; border:1px solid var(--border); padding:6px 10px; border-radius:8px; color:var(--fg)}
        .header-actions{display:flex; gap:10px; align-items:center}
        .search{border:1px solid var(--border); background:transparent; color:var(--fg); padding:8px 10px; border-radius:8px; min-width:220px}
        .btn{display:inline-block; padding:10px 12px; border-radius:8px; text-decoration:none; font-weight:500; font-size:14px; cursor:pointer; transition:opacity .2s; border:1px solid var(--border); background:var(--btn); color:var(--fg)}
        .btn:hover{opacity:.9}
        .btn-primary{background:var(--accent); color:#fff; border-color:transparent}
        .btn-secondary{background:var(--btn); color:var(--fg)}
        .chip{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
        main{flex:1; padding:20px}

        .form-container{max-width:600px;margin:0 auto;padding:20px;box-shadow:0 0 10px rgba(0,0,0,.08);background:var(--card);border-radius:12px;border:1px solid var(--border)}
        .form-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
        h1{color:var(--fg);font-size:22px;margin:0}
        .form-group{margin-bottom:15px}
        label{display:block;margin-bottom:6px;font-weight:700;color:var(--muted)}
        input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;background:transparent;color:var(--fg)}
        .inline{display:flex; gap:10px}
        .inline .form-group{flex:1}
        .error{color:#e74c3c;font-size:14px;margin-top:5px;display:block}
        .pw-row{display:flex; gap:8px; align-items:center}
        .pw-tools{display:flex; gap:8px; flex-wrap:wrap}
        .meter-wrap{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; border:1px solid var(--border)}
        .dark .meter-wrap{background:#1f2937}
        .meter{height:100%; width:0%; background:#ef4444; transition:width .2s}
        .meter.ok{background:#f59e0b}
        .meter.good{background:#22c55e}
        footer{border-top:1px solid var(--border); padding:12px 20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; background:var(--bg)}
        .footer-actions{display:flex; gap:8px; flex-wrap:wrap}
        @media (max-width:768px){.inline{flex-direction:column}}
    </style>
</head>
<body>

<!-- HEADER com navegação, busca e alternância de tema -->
<header>
    <div class="topbar">
        <div class="brand">MottuSense • Usuários</div>
        <nav>
            <a th:href="@{/usuariosview/listar}">Voltar</a>
            <a th:href="@{/filiaisview/listar}">Filiais</a>
        </nav>
        <div class="header-actions">
            <input id="q" class="search" type="search" placeholder="Atalho: / — pesquisar na lista" aria-label="Pesquisar" />
            <span class="chip" title="Campos obrigatórios restantes"><span id="reqCount">—</span> obrigatórios</span>
            <button id="toggleTheme" class="btn btn-secondary" type="button" title="Alternar tema">Tema</button>
        </div>
    </div>
</header>

<main>
    <div class="form-container">
        <div class="form-head">
            <h1 th:text="${titulo} ?: 'Adicionar Usuário'">Adicionar Usuário</h1>
        </div>

        <!-- IMPORTANTE: ligado ao DTO CadastroUsuarioRequestDTO -->
        <form th:action="@{/usuariosview/salvar}" th:object="${usuario}" method="post" id="userForm" novalidate>
            <!-- CSRF -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="form-group">
                <label for="nomeUsuario">Nome:</label>
                <input type="text" id="nomeUsuario" th:field="*{nomeUsuario}" required>
                <span class="error" th:if="${#fields.hasErrors('nomeUsuario')}" th:errors="*{nomeUsuario}"></span>
            </div>

            <div class="form-group">
                <label for="emailUsuario">Email:</label>
                <input type="email" id="emailUsuario" th:field="*{emailUsuario}" required>
                <span class="error" th:if="${#fields.hasErrors('emailUsuario')}" th:errors="*{emailUsuario}"></span>
            </div>

            <div class="form-group">
                <label for="senhaUsuario">Senha:</label>
                <div class="pw-row">
                    <input type="password" id="senhaUsuario" th:field="*{senhaUsuario}" required>
                    <div class="pw-tools">
                        <button class="btn btn-secondary" type="button" id="togglePw">Mostrar</button>
                        <button class="btn btn-secondary" type="button" id="genPw">Gerar</button>
                    </div>
                </div>
                <div class="meter-wrap" aria-hidden="true" style="margin-top:8px">
                    <div id="pwMeter" class="meter"></div>
                </div>
                <small id="pwHint" class="chip" style="margin-top:6px; display:inline-block">Força: —</small>
                <span class="error" th:if="${#fields.hasErrors('senhaUsuario')}" th:errors="*{senhaUsuario}"></span>
            </div>

            <div class="form-group">
                <label for="cpfUsuario">CPF:</label>
                <input type="text" id="cpfUsuario" th:field="*{cpfUsuario}" maxlength="11" inputmode="numeric" required>
                <span class="error" th:if="${#fields.hasErrors('cpfUsuario')}" th:errors="*{cpfUsuario}"></span>
            </div>

            <div class="form-group">
                <label for="telefoneUsuario">Telefone:</label>
                <input type="text" id="telefoneUsuario" th:field="*{telefoneUsuario}" inputmode="numeric" required>
                <span class="error" th:if="${#fields.hasErrors('telefoneUsuario')}" th:errors="*{telefoneUsuario}"></span>
            </div>

            <div class="inline">
                <div class="form-group">
                    <label for="dia">Dia Nascimento:</label>
                    <input type="number" id="dia" th:field="*{dia}" min="1" max="31" required>
                    <span class="error" th:if="${#fields.hasErrors('dia')}" th:errors="*{dia}"></span>
                </div>

                <div class="form-group">
                    <label for="mes">Mês Nascimento:</label>
                    <input type="number" id="mes" th:field="*{mes}" min="1" max="12" required>
                    <span class="error" th:if="${#fields.hasErrors('mes')}" th:errors="*{mes}"></span>
                </div>

                <div class="form-group">
                    <label for="ano">Ano Nascimento:</label>
                    <input type="number" id="ano" th:field="*{ano}" min="1900" th:max="${T(java.time.LocalDate).now().year}" required>
                    <span class="error" th:if="${#fields.hasErrors('ano')}" th:errors="*{ano}"></span>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">Cadastrar Usuário</button>
            </div>
        </form>
    </div>
</main>

<!-- FOOTER com utilidades -->
<footer>
    <div class="chip">Dica: use “/” para focar a busca • Tema persiste entre visitas</div>
    <div class="footer-actions">
        <button type="button" class="btn btn-secondary" id="clearForm">Limpar</button>
        <button type="button" class="btn btn-secondary" id="printPage">Imprimir</button>
        <button type="button" class="btn btn-secondary" id="toTop">Topo</button>
    </div>
</footer>

<script>
    // Tema com persistência
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme') || 'light';
      if(saved === 'dark'){ root.classList.add('dark'); }
      document.getElementById('toggleTheme').addEventListener('click', () => {
        root.classList.toggle('dark');
        localStorage.setItem('theme', root.classList.contains('dark') ? 'dark' : 'light');
      });
    })();

    // Atalho "/" para focar a busca
    (function(){
      const q = document.getElementById('q');
      window.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== q) {
          e.preventDefault(); q?.focus();
        }
      });
    })();

    // Contar obrigatórios faltando (client-side)
    (function(){
      const form = document.getElementById('userForm');
      const reqCount = document.getElementById('reqCount');
      const update = () => {
        const required = form.querySelectorAll('[required]');
        let missing = 0;
        required.forEach(el => {
          if(!el.value || (el.type === 'number' && el.value === '')) missing++;
        });
        reqCount.textContent = missing;
      };
      form.addEventListener('input', update);
      update();
    })();

    // Utilidades do rodapé
    document.getElementById('clearForm')?.addEventListener('click', () => {
      if(confirm('Limpar todos os campos?')){
        document.getElementById('userForm').reset();
        document.getElementById('reqCount').textContent = document.querySelectorAll('#userForm [required]').length;
        document.getElementById('pwMeter').style.width = '0%';
        document.getElementById('pwMeter').className = 'meter';
        document.getElementById('pwHint').textContent = 'Força: —';
      }
    });
    document.getElementById('printPage')?.addEventListener('click', () => window.print());
    document.getElementById('toTop')?.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));

    // Só dígitos para CPF/Telefone
    (function(){
      const onlyDigits = el => el && el.addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g, '');
      });
      onlyDigits(document.getElementById('cpfUsuario'));
      onlyDigits(document.getElementById('telefoneUsuario'));
    })();

    // Mostrar/ocultar senha + gerador + medidor de força
    (function(){
      const input = document.getElementById('senhaUsuario');
      const toggle = document.getElementById('togglePw');
      const gen = document.getElementById('genPw');
      const meter = document.getElementById('pwMeter');
      const hint = document.getElementById('pwHint');

      function score(pw){
        let s = 0;
        if(!pw) return 0;
        if(pw.length >= 8) s+=25;
        if(pw.length >= 12) s+=10;
        if(/[a-z]/.test(pw)) s+=15;
        if(/[A-Z]/.test(pw)) s+=15;
        if(/[0-9]/.test(pw)) s+=15;
        if(/[^A-Za-z0-9]/.test(pw)) s+=20;
        return Math.min(s, 100);
      }
      function updateMeter(){
        const val = input.value || '';
        const sc = score(val);
        meter.style.width = sc + '%';
        meter.className = 'meter' + (sc>=70 ? ' good' : sc>=40 ? ' ok' : '');
        hint.textContent = 'Força: ' + (sc>=70 ? 'Boa' : sc>=40 ? 'Média' : 'Fraca');
      }
      toggle.addEventListener('click', () => {
        if(input.type === 'password'){ input.type = 'text'; toggle.textContent = 'Ocultar'; }
        else { input.type = 'password'; toggle.textContent = 'Mostrar'; }
      });
      gen.addEventListener('click', () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%*?';
        let out = '';
        for(let i=0;i<14;i++){ out += chars[Math.floor(Math.random()*chars.length)]; }
        input.value = out;
        updateMeter();
      });
      input.addEventListener('input', updateMeter);
    })();

    // Aviso de navegação com alterações não salvas
    (function(){
      const form = document.getElementById('userForm');
      let dirty = false;
      form.addEventListener('input', () => dirty = true);
      window.addEventListener('beforeunload', (e) => {
        if(dirty){ e.preventDefault(); e.returnValue = ''; }
      });
      form.addEventListener('submit', () => { dirty = false; });
    })();
</script>
</body>
</html>
