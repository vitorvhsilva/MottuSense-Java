<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Editar Usuário</title>
    <link rel="stylesheet" th:href="@{/css/usuarios.css}"/>
</head>
<body>

<!-- HEADER com navegação e tema -->
<header>
    <div class="topbar">
        <div class="brand">MottuSense • Usuários</div>
        <nav>
            <a th:href="@{/usuariosview/listar}">Voltar</a>
            <a th:href="@{/usuariosview/adicionar}">Novo Usuário</a>
            <a th:href="@{/filiaisview/listar}">Filiais</a>
        </nav>
        <button id="toggleTheme" class="btn" type="button" title="Alternar tema">Tema</button>
    </div>
</header>

<main>
    <h1>Editar Usuário</h1>

    <!-- Banner de sucesso -->
    <div class="alert-success" th:if="${sucesso} != null or ${param.sucesso} != null">
        <span th:text="${sucesso} ?: 'Usuário atualizado com sucesso'">Usuário atualizado com sucesso</span>
    </div>

    <!-- ID vindo como atributo separado -->
    <p class="muted">ID: <span th:text="${idUsuario}">id</span></p>

    <form th:action="@{/usuariosview/atualizar/{id}(id=${idUsuario})}"
          th:object="${usuario}"
          method="post">

        <!-- CSRF -->
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

        <!-- Envia o ID no corpo sem depender do DTO -->
        <input type="hidden" name="idUsuario" th:value="${idUsuario}"/>

        <div class="field">
            <label for="nomeUsuario">Nome</label>
            <input id="nomeUsuario" type="text" th:field="*{nomeUsuario}" />
            <div class="error" th:if="${#fields.hasErrors('nomeUsuario')}" th:errors="*{nomeUsuario}"></div>
        </div>

        <div class="field">
            <div class="row">
                <label for="senhaUsuario" style="margin:0">Senha</label>
                <small class="muted">Dica: use 12+ caracteres</small>
            </div>
            <!-- mantém o MESMO name para não quebrar o binding do controller -->
            <input id="senhaUsuario"
                   type="password"
                   name="senhaUsuario"
                   autocomplete="new-password"
                   placeholder="Digite a nova senha" />
            <div class="pw-tools">
                <button class="btn" type="button" id="togglePw">Mostrar</button>
                <button class="btn" type="button" id="genPw">Gerar senha forte</button>
            </div>
            <div class="meter-wrap" aria-hidden="true">
                <div id="pwMeter" class="meter"></div>
            </div>
            <small id="pwHint" class="chip" style="margin-top:6px; display:inline-block">Força: —</small>

            <div class="error" th:if="${#fields.hasErrors('senhaUsuario')}" th:errors="*{senhaUsuario}"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" type="submit">Atualizar</button>
            <a class="link" th:href="@{/usuariosview/listar}">Cancelar</a>
        </div>
    </form>
</main>

<!-- FOOTER com utilidades da página -->
<footer>
    <div class="chip">Alterações não salvas geram aviso ao sair • Tema persiste</div>
    <div>
        <button type="button" class="btn" id="toTop">Topo</button>
    </div>
</footer>

<script>
    // Tema com persistência
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('theme') || 'light';
      if(saved === 'dark'){ root.classList.add('dark'); }
      btn.addEventListener('click', () => {
        root.classList.toggle('dark');
        localStorage.setItem('theme', root.classList.contains('dark') ? 'dark' : 'light');
      });
    })();

    // Mostrar/ocultar senha + gerador + medidor de força
    (function(){
      const input = document.getElementById('senhaUsuario');
      const toggle = document.getElementById('togglePw');
      const gen = document.getElementById('genPw');
      const meter = document.getElementById('pwMeter');
      const hint = document.getElementById('pwHint');

      function score(pw){
        let s = 0;
        if(!pw) return 0;
        if(pw.length >= 8) s+=25;
        if(pw.length >= 12) s+=10;
        if(/[a-z]/.test(pw)) s+=15;
        if(/[A-Z]/.test(pw)) s+=15;
        if(/[0-9]/.test(pw)) s+=15;
        if(/[^A-Za-z0-9]/.test(pw)) s+=20;
        return Math.min(s, 100);
      }
      function updateMeter(){
        const val = input.value || '';
        const sc = score(val);
        meter.style.width = sc + '%';
        meter.className = 'meter' + (sc>=70 ? ' good' : sc>=40 ? ' ok' : '');
        hint.textContent = 'Força: ' + (sc>=70 ? 'Boa' : sc>=40 ? 'Média' : 'Fraca');
      }
      toggle.addEventListener('click', () => {
        if(input.type === 'password'){ input.type = 'text'; toggle.textContent = 'Ocultar'; }
        else { input.type = 'password'; toggle.textContent = 'Mostrar'; }
      });
      gen.addEventListener('click', () => {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%*?';
        let out = '';
        for(let i=0;i<14;i++){ out += chars[Math.floor(Math.random()*chars.length)]; }
        input.value = out;
        updateMeter();
      });
      input.addEventListener('input', updateMeter);
    })();

    // Aviso de navegação com alterações não salvas
    (function(){
      const form = document.querySelector('form');
      let dirty = false;
      form.addEventListener('input', () => dirty = true);
      window.addEventListener('beforeunload', (e) => {
        if(dirty){ e.preventDefault(); e.returnValue = ''; }
      });
      form.addEventListener('submit', () => { dirty = false; });
    })();

    // utilidades do footer
    document.getElementById('printPage')?.addEventListener('click', () => window.print());
    document.getElementById('toTop')?.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
</script>
</body>
</html>
