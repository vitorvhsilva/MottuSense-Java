<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Filiais</title>
    <link rel="stylesheet" th:href="@{/css/filiais.css}"/>
</head>
<body>

<!-- HEADER com navegação, busca e tema -->
<header>
    <div class="topbar">
        <div class="brand">MottuSense • Filiais</div>
        <nav>
            <a th:href="@{/usuariosview/listar}">Usuários</a>
        </nav>
        <div class="actions-bar">
            <input id="q" type="search" placeholder="Pesquisar (/, Enter) — nome, CEP, estado..." aria-label="Pesquisar filiais" />
            <button id="toggleTheme" class="btn" type="button">Tema</button>
            <a class="btn" th:href="@{/filiaisview/adicionar}">Nova Filial</a>
        </div>
    </div>
</header>

<main>
    <!-- Banner de sucesso vindo por query param (?sucesso=1) ou por atributo de modelo 'sucesso' -->
    <div class="alert-success" th:if="${param.sucesso} != null or ${sucesso} != null">
        <span th:text="${sucesso} ?: 'Operação realizada com sucesso'">Operação realizada com sucesso</span>
    </div>

    <table id="tbl">
        <thead>
        <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>CEP</th>
            <th>Logradouro</th>
            <th>Bairro</th>
            <th>Estado</th>
            <th>Região</th>
            <th>Ações</th>
        </tr>
        </thead>
        <tbody id="tbody">
        <tr th:each="f : ${filiais}">
            <td th:text="${f.idFilial}">id</td>
            <td th:text="${f.nomeFilial}">nome</td>
            <td th:text="${f.localizacao?.cepLocalizacao}">cep</td>
            <td th:text="${f.localizacao?.logradouroLocalizacao}">logradouro</td>
            <td th:text="${f.localizacao?.bairroLocalizacao}">bairro</td>
            <td th:text="${f.localizacao?.estadoLocalizacao}">estado</td>
            <td th:text="${f.localizacao?.regiaoLocalizacao}">região</td>
            <td class="actions">
                <a th:href="@{/filiaisview/editar/{id}(id=${f.idFilial})}">Editar</a>

                <!-- Excluir via POST (com CSRF) -->
                <form th:action="@{/filiaisview/excluir/{id}(id=${f.idFilial})}" method="post"
                      onsubmit="return confirm('Excluir esta filial?')">
                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                    <button type="submit" class="btn-link">Excluir</button>
                </form>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(filiais)}">
            <td colspan="8" class="muted">Nenhuma filial encontrada.</td>
        </tr>
        </tbody>
    </table>
</main>

<!-- FOOTER com contadores e exportação CSV -->
<footer>
    <div class="stats">
        Total: <strong id="countTotal" th:text="${filiais != null ? #lists.size(filiais) : 0}">0</strong> •
        Visíveis: <strong id="countVisible">0</strong>
    </div>
    <div class="right">
        <button id="toTop" class="btn" type="button">Topo</button>
    </div>
</footer>

<script>
    // Tema persistente
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('theme') || 'light';
      if (saved === 'dark') root.classList.add('dark');
      btn.addEventListener('click', () => {
        root.classList.toggle('dark');
        localStorage.setItem('theme', root.classList.contains('dark') ? 'dark' : 'light');
      });
    })();

    // Filtro rápido na tabela
    (function(){
      const q = document.getElementById('q');
      const tbody = document.getElementById('tbody');
      const rows = () => Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.children.length > 1); // ignora "nenhuma filial"
      const countVisible = document.getElementById('countVisible');

      function applyFilter() {
        const term = q.value.trim().toLowerCase();
        let visible = 0;
        rows().forEach(tr => {
          const txt = tr.innerText.toLowerCase();
          const show = term === '' || txt.includes(term);
          tr.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        countVisible.textContent = String(visible);
      }

      // Inicializa contagem
      window.addEventListener('DOMContentLoaded', applyFilter);

      q.addEventListener('input', applyFilter);

      // Atalhos: "/" foca a busca, Enter aplica (já aplica em input)
      window.addEventListener('keydown', (e)=>{
        if (e.key === '/' && document.activeElement !== q) {
          e.preventDefault();
          q.focus();
        }
      });
    })();

    // Voltar ao topo
    document.getElementById('toTop').addEventListener('click', () => {
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Atualiza "Visíveis" no load completo (caso o DOMContentLoaded dispare antes de Thymeleaf renderizar)
    window.addEventListener('load', ()=>{
      const evt = new Event('input');
      document.getElementById('q').dispatchEvent(evt);
    });
</script>
</body>
</html>
